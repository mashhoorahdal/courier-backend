{% extends 'admin/base.html' %}

{% block title %}Update Delivery Status - Courier Admin{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h3 mb-0">Update Delivery Status</h1>
            <a href="{% url 'admin_deliveries' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Deliveries
            </a>
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0">Update Status for Delivery {{ delivery.order.barcode }}</h6>
            </div>
            <div class="card-body">
                <!-- Delivery Details -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6>Delivery Details</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Order:</strong></td>
                                <td><code>{{ delivery.order.barcode }}</code></td>
                            </tr>
                            <tr>
                                <td><strong>Customer:</strong></td>
                                <td>{{ delivery.order.customer.get_full_name|default:delivery.order.customer.username }}</td>
                            </tr>
                            <tr>
                                <td><strong>Delivery Boy:</strong></td>
                                <td>{{ delivery.delivery_boy.user.get_full_name|default:delivery.delivery_boy.user.username }}</td>
                            </tr>
                            <tr>
                                <td><strong>Current Status:</strong></td>
                                <td>
                                    <span class="badge bg-{% if delivery.status == 'delivered' %}success{% elif delivery.status == 'in_transit' %}primary{% elif delivery.status == 'picked_up' %}warning{% elif delivery.status == 'assigned' %}info{% else %}danger{% endif %}">
                                        {{ delivery.get_status_display }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Assigned:</strong></td>
                                <td>{{ delivery.assigned_at|date:"M d, Y H:i" }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Delivery Address</h6>
                        <address>
                            {{ delivery.order.receiver_address|linebreaks }}
                        </address>
                        {% if delivery.notes %}
                        <h6 class="mt-3">Notes</h6>
                        <p class="text-muted">{{ delivery.notes }}</p>
                        {% endif %}
                    </div>
                </div>

                <hr>

                <form method="post">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="status" class="form-label">New Status *</label>
                        <select name="status" id="status" class="form-select" required>
                            {% if delivery.status == 'assigned' %}
                            <option value="picked_up">Picked Up</option>
                            <option value="failed">Failed</option>
                            {% elif delivery.status == 'picked_up' %}
                            <option value="in_transit">In Transit</option>
                            <option value="failed">Failed</option>
                            {% elif delivery.status == 'in_transit' %}
                            <option value="delivered">Delivered</option>
                            <option value="failed">Failed</option>
                            {% endif %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea name="notes" id="notes" class="form-control" rows="3"
                                  placeholder="Add any additional notes...">{{ delivery.notes }}</textarea>
                    </div>

                    <!-- Rating and Feedback (only for delivered status) -->
                    <div id="rating-section" style="display: none;">
                        <h6 class="mb-3">Customer Feedback</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="rating" class="form-label">Rating (1-5)</label>
                                <select name="rating" id="rating" class="form-select">
                                    <option value="">No rating</option>
                                    <option value="1">1 - Poor</option>
                                    <option value="2">2 - Fair</option>
                                    <option value="3">3 - Good</option>
                                    <option value="4">4 - Very Good</option>
                                    <option value="5">5 - Excellent</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="feedback" class="form-label">Customer Feedback</label>
                                <textarea name="feedback" id="feedback" class="form-control" rows="2"
                                          placeholder="Customer feedback...">{{ delivery.customer_feedback }}</textarea>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <a href="{% url 'admin_deliveries' %}" class="btn btn-outline-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Update Status
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.form-select, .form-control {
    border-radius: 0.375rem;
}

address {
    font-style: normal;
    line-height: 1.5;
}

/* Mobile optimizations */
@media (max-width: 767.98px) {
    .card-body {
        padding: 1rem;
    }

    .row.mb-4 .col-md-6 {
        margin-bottom: 1.5rem;
    }

    .btn {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }

    .d-flex.justify-content-between {
        flex-direction: column;
        gap: 1rem;
    }

    .d-flex.justify-content-between .btn {
        align-self: flex-start;
    }

    .form-label {
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }

    .card-header h6 {
        font-size: 1rem;
    }

    h6 {
        font-size: 1rem;
    }

    /* Stack form buttons on mobile */
    .d-flex.justify-content-end {
        flex-direction: column;
        gap: 0.5rem;
    }

    .d-flex.justify-content-end .btn {
        width: 100%;
    }

    /* Table styling on mobile */
    .table.table-sm td,
    .table.table-sm th {
        padding: 0.5rem;
        font-size: 0.875rem;
    }

    .table.table-sm td strong {
        font-size: 0.875rem;
    }

    /* Rating section on mobile */
    .row .col-md-6 {
        margin-bottom: 1rem;
    }
}
</style>

<script>
document.getElementById('status').addEventListener('change', function() {
    const ratingSection = document.getElementById('rating-section');
    if (this.value === 'delivered') {
        ratingSection.style.display = 'block';
    } else {
        ratingSection.style.display = 'none';
    }
});
</script>
{% endblock %}
